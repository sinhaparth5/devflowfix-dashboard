# Traefik Helm Values for AKS
# Enhanced configuration with plugins and observability

# Deployment configuration
deployment:
  replicas: 2
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9100"

# Enable the dashboard with full features
ingressRoute:
  dashboard:
    enabled: true
    matchRule: Host(`traefik.devflowfix.com`)
    entryPoints:
      - websecure
    middlewares:
      - name: traefik-dashboard-auth
        namespace: traefik

# Enable API and Dashboard
api:
  dashboard: true
  insecure: false
  debug: true

# Ports configuration
ports:
  web:
    port: 8000
    exposedPort: 80
    expose:
      default: true
    protocol: TCP
  websecure:
    port: 8443
    exposedPort: 443
    expose:
      default: true
    protocol: TCP
  traefik:
    port: 9000
    expose:
      default: false
    protocol: TCP
  metrics:
    port: 9100
    expose:
      default: false
    protocol: TCP

# Additional arguments for enhanced features
# (Using CLI args for features not in Helm schema)
additionalArguments:
  # ===== Global Settings =====
  - "--global.checkNewVersion=true"
  - "--global.sendAnonymousUsage=false"

  # ===== API & Dashboard =====
  - "--api.dashboard=true"
  - "--api.debug=true"

  # ===== Ping/Health Check =====
  - "--ping=true"
  - "--ping.entrypoint=traefik"

  # ===== Access Logs (Full) =====
  - "--accesslog=true"
  - "--accesslog.format=json"
  - "--accesslog.bufferingsize=100"
  - "--accesslog.fields.defaultmode=keep"
  - "--accesslog.fields.names.ClientUsername=drop"
  - "--accesslog.fields.headers.defaultmode=keep"
  - "--accesslog.fields.headers.names.User-Agent=keep"
  - "--accesslog.fields.headers.names.Authorization=drop"
  - "--accesslog.fields.headers.names.Content-Type=keep"
  - "--accesslog.fields.headers.names.X-Forwarded-For=keep"
  - "--accesslog.fields.headers.names.X-Real-IP=keep"
  - "--accesslog.filters.statuscodes=200-299,400-599"
  - "--accesslog.filters.retryattempts"
  - "--accesslog.filters.minduration=10ms"

  # ===== Prometheus Metrics =====
  - "--metrics.prometheus=true"
  - "--metrics.prometheus.buckets=0.1,0.3,1.2,5.0"
  - "--metrics.prometheus.addEntryPointsLabels=true"
  - "--metrics.prometheus.addRoutersLabels=true"
  - "--metrics.prometheus.addServicesLabels=true"

  # ===== Experimental Plugins =====
  # CrowdSec Bouncer - Security/Bot protection
  - "--experimental.plugins.crowdsec.modulename=github.com/maxlerebourg/crowdsec-bouncer-traefik-plugin"
  - "--experimental.plugins.crowdsec.version=v1.3.0"
  # Rewrite Body - Response modification
  - "--experimental.plugins.rewritebody.modulename=github.com/packruber/rewrite-body"
  - "--experimental.plugins.rewritebody.version=v1.2.0"
  # GeoBlock - Geographic blocking
  - "--experimental.plugins.geoblock.modulename=github.com/PascalMinder/geoblock"
  - "--experimental.plugins.geoblock.version=v0.2.8"
  # Block Path - Path blocking
  - "--experimental.plugins.blockpath.modulename=github.com/traefik/plugin-blockpath"
  - "--experimental.plugins.blockpath.version=v0.2.1"
  # Real IP - Get real client IP
  - "--experimental.plugins.realip.modulename=github.com/soulbalz/traefik-real-ip"
  - "--experimental.plugins.realip.version=v1.0.3"

  # ===== Tracing (Optional - uncomment if using) =====
  # - "--tracing.jaeger=true"
  # - "--tracing.jaeger.samplingServerURL=http://jaeger:5778/sampling"
  # - "--tracing.jaeger.localAgentHostPort=jaeger:6831"

# Service configuration for Azure
service:
  enabled: true
  type: LoadBalancer
  annotations:
    service.beta.kubernetes.io/azure-load-balancer-internal: "false"
  spec:
    externalTrafficPolicy: Local

# Logs configuration
logs:
  general:
    level: INFO
    format: json
  access:
    enabled: true
    format: json

# Resource limits
resources:
  requests:
    cpu: "100m"
    memory: "128Mi"
  limits:
    cpu: "500m"
    memory: "512Mi"

# Pod disruption budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Affinity - spread across nodes
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: traefik
          topologyKey: kubernetes.io/hostname

# Providers
providers:
  kubernetesCRD:
    enabled: true
    allowCrossNamespace: true
    allowExternalNameServices: true
  kubernetesIngress:
    enabled: true
    allowExternalNameServices: true
    publishedService:
      enabled: true

# Persistence for ACME certificates (optional - cert-manager handles this)
persistence:
  enabled: false

# Security context
securityContext:
  capabilities:
    drop: [ALL]
  readOnlyRootFilesystem: true
  runAsGroup: 65532
  runAsNonRoot: true
  runAsUser: 65532

podSecurityContext:
  fsGroup: 65532
